<!-- The exported code uses Tailwind CSS. Install Tailwind CSS in your dev environment to ensure all styles work. -->
<template>
  <div
      class="min-h-screen bg-white text-gray-900 flex flex-col items-center py-10 px-4"
  >
    <Header />
    <!-- ‰∏™‰∫∫‰ø°ÊÅØÂå∫Âüü -->
    <div class="relative w-full max-w-4xl flex flex-col items-center mb-10 mt-10">
      <!-- Â§¥ÂÉèÂíåÁî®Êà∑Âêç -->
      <div class="relative group">
        <div
            class="w-48 h-48 rounded-full overflow-hidden border-4 border-gray-800 shadow-lg mb-4 group-hover:scale-105 transition-transform duration-300"
        >
          <img
              :src="userInfo.avatarUrl"
              alt="Áî®Êà∑Â§¥ÂÉè"
              class="w-full h-full object-cover object-top"
          />
        </div>
        <div v-if="isCanEdit">
          <button
              @click="openEditModal"
              class="absolute top-0 right-0 bg-gray-800 text-white p-2 rounded-full cursor-pointer hover:bg-gray-600 transition-colors duration-300"
          >
            <i class="fas fa-pencil-alt"></i>
          </button>
        </div>
      </div>
      <div class="text-center">
        <div v-if="editMode" class="mb-2">
          <el-input
              v-model="editForm.username"
              placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç"
              maxlength="20"
              minlength="0"
          ></el-input>
        </div>
        <h1 v-else class="text-3xl font-bold mb-2" :class = GetTextColor(userInfo.level) >{{ userInfo.username }}</h1>
        
        <!-- ‰∏™ÊÄßÁ≠æÂêç -->
        <div v-if="editMode" class="mb-6">
          <el-input
              v-model="editForm.signature"
              placeholder="ÂÜô‰∏ã‰Ω†ÁöÑ‰∏™ÊÄßÁ≠æÂêç..."
              maxlength="200"
          ></el-input>
        </div>
        <p v-else class="text-gray-500 italic text-sm mb-6">{{ userInfo.signature || 'Ê≠§‰∫∫ÂæàÊáí‰ªÄ‰πà‰πüÊ≤°ÂÜô' }}</p>
      </div>

      <div class="w-full m-2 flex justify-end">
        <div v-if="editMode">
          <el-button
              plain
              @click="editMode = false"
          >ÂèñÊ∂à</el-button>
          <el-button
              type="success"
              plain
              @click="saveUserInfo"
          >
            ‰øùÂ≠ò
          </el-button>
        </div>
        <div v-else-if="isCanEdit">
          <el-button
              type="primary"
              @click="openEditMode()"
              plain
          >ÁºñËæë</el-button>
        </div>
      </div>
      <!-- ‰∏™‰∫∫ËØ¶ÁªÜ‰ø°ÊÅØÂç°Áâá -->
      <div
          class="w-full bg-white border-2 border-gray-800 rounded-lg p-6 shadow-lg"
      >
        <div class="mb-6">
          <div class="flex">
            <p class="text-sm text-gray-600 mb-1">ÁªèÈ™åÂÄº(ÁõÆÂâçË∫´‰ªΩÔºö</p>
            <p class="text-sm mb-1" :class = GetTextColor(userInfo.level)>{{GetRoleName(userInfo.level)}}</p>
            <p class="text-sm text-gray-600 mb-1">)</p>
          </div>

          <div class="w-full bg-gray-200 rounded-full h-4">
            <div
                class="h-4 rounded-full"
                :class = GetBgColor(userInfo.level)
                :style="{ width: `${userInfo.experiencePercentage}%` }"
            ></div>
          </div>
          <div class="text-right text-sm mt-1">
            {{ userInfo.experience }} / {{ userInfo.maxExperience }}
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="flex flex-col space-y-4">
            <div>
              <p class="text-sm text-gray-600">ÁúüÂÆûÂßìÂêç</p>
              <div v-if="editMode && isAdmin">
                <el-input
                    v-model="editForm.realName"
                    placeholder="ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç"
                    maxlength="10"
                    minlength="2"
                ></el-input>
                <div v-show="editForm.realName.length < 2" class="text-sm text-red-500">ÂßìÂêçÈïøÂ∫¶ÂøÖÈ°ªÂú®2-10‰∏™Â≠óÁ¨¶‰πãÈó¥ÔºÅ</div>
              </div>
              <div v-else>
                <p class="font-medium">{{ userInfo.realName }}</p>
              </div>
            </div>
            <div>
              <p class="text-sm text-gray-600">Âπ¥Á∫ß</p>
              <div v-if="editMode && isAdmin">
                <el-input-number
                    v-model="editForm.grade"
                    :min="20"
                    :max="99"
                    controls-position="right"
                    size="large"
                    placeholder="ËØ∑ËæìÂÖ•Âπ¥Á∫ß(‰æãÂ¶Ç:23)"
                />
              </div>
              <div v-else>
                <p class="font-medium">{{ userInfo.grade }}</p>
              </div>
            </div>
            <div>
              <p class="text-sm text-gray-600">Â≠¶Âè∑</p>
              <div v-if="editMode && isAdmin">
                <el-input
                    v-model="editForm.studentId"
                    placeholder="ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç"
                    maxlength="20"
                    minlength="0"
                ></el-input>
              </div>
              <div v-else>
                <p class="font-medium">{{ userInfo.studentId }}</p>
              </div>
            </div>
            <div v-if="isSuperAdmin && editMode">
              <p class="text-sm text-gray-600">Áî®Êà∑Ë∫´‰ªΩ</p>
              <el-select
                  v-model="editForm.role"
                  placeholder="Select"
                  size="large"
                  style="width: 240px"
              >
                <el-option
                    v-for="item in roleOptions"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                />
              </el-select>
            </div>
          </div>
          <div class="flex flex-col space-y-4">
            <div>
              <p class="text-sm text-gray-600">Codeforces ID</p>
              <div v-if="editMode">
                <el-input
                    v-model="editForm.codeforcesId"
                    placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑCodeforces ID"
                    maxlength="30"
                    minlength="0"
                ></el-input>
              </div>
              <div v-else>
                <a
                    :href="`https://codeforces.com/profile/${userInfo.codeforcesId}`"
                    target="_blank"
                    class="font-medium text-blue-600 hover:underline cursor-pointer"
                >{{ userInfo.codeforcesId }}</a>
              </div>
            </div>
            <div>
              <p class="text-sm text-gray-600">Codeforces Rating</p>
              <p class="font-medium" :class="getRatingColorClass()">
                {{ userInfo.codeforcesRating }}
              </p>
            </div>
          </div>
        </div>

        <!-- Ëé∑Â•ñÁªèÂéÜ -->
        <div v-if="editMode || userInfo.awards.length > 0" class="mt-6 pt-6 border-t-2 border-gray-200">
          <div class="flex justify-between items-center mb-6">
            <p class="text-lg font-semibold text-gray-800">üèÜ Ëé∑Â•ñÁªèÂéÜ</p>
            <el-button 
                v-if="editMode" 
                type="primary" 
                size="small" 
                @click="addAward"
                plain
            >
              <i class="fas fa-plus mr-1"></i> Ê∑ªÂä†Â•ñÈ°π
            </el-button>
          </div>
          
          <!-- ÁºñËæëÊ®°Âºè -->
          <div v-if="editMode && editForm.awards.length > 0" class="space-y-3">
            <div 
                v-for="(award, index) in editForm.awards" 
                :key="index"
                class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-2 border-gray-200"
            >
              <el-input
                  v-model="award.name"
                  placeholder="Â•ñÈ°πÂêçÁß∞"
                  class="flex-1"
                  maxlength="50"
              ></el-input>
              <el-select
                  v-model="award.level"
                  placeholder="Á≠âÁ∫ß"
                  style="width: 120px"
              >
                <el-option label="‰∏ÄÁ≠âÂ•ñ/ÈáëÂ•ñ" :value="1"></el-option>
                <el-option label="‰∫åÁ≠âÂ•ñ/Èì∂Â•ñ" :value="2"></el-option>
                <el-option label="‰∏âÁ≠âÂ•ñ/ÈìúÂ•ñ" :value="3"></el-option>
              </el-select>
              <el-button 
                  type="danger" 
                  size="small" 
                  circle
                  @click="removeAward(index)"
              >
                <i class="fas fa-trash"></i>
              </el-button>
            </div>
          </div>
          
          <!-- ÊòæÁ§∫Ê®°Âºè - Êó∂Èó¥Á∫øÊ†∑Âºè -->
          <div v-else-if="!editMode && userInfo.awards.length > 0" class="relative pl-6">
            <div 
                v-for="(award, index) in userInfo.awards" 
                :key="index"
                class="relative pb-4 last:pb-0"
            >
              <!-- ËøûÊé•Á∫ø -->
              <div 
                  v-if="index < userInfo.awards.length - 1"
                  class="absolute left-0 top-4 w-0.5 h-full -ml-3"
                  :class="getAwardLineColor(award.level)"
              ></div>
              
              <!-- ÂúÜÁÇπ -->
              <div 
                  class="absolute left-0 top-0.5 w-5 h-5 -ml-5 rounded-full shadow-md transition-transform duration-300 hover:scale-125"
                  :class="getAwardCircleClass(award.level)"
              >
              </div>
              
              <!-- Â•ñÈ°πÂÜÖÂÆπ -->
              <div class="ml-2 transition-all duration-300 hover:translate-x-1">
                <p class="font-medium text-gray-800 text-base">

                  <span class="mr-1" :class="getAwardTextColor(award.level)">{{ award.name }}</span>
                  <span class="mr-1">{{ getAwardIcon(award.level) }}</span>
                </p>
              </div>
            </div>
          </div>
          
          <!-- Á©∫Áä∂ÊÄÅ -->
          <div v-else-if="!editMode" class="text-center text-gray-400 py-8">
            <i class="fas fa-trophy text-4xl mb-2"></i>
            <p>ÊöÇÊó†Ëé∑Â•ñËÆ∞ÂΩï</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ÂÜÖÂÆπÂ±ïÁ§∫Âå∫Âüü -->
    <div class="w-full max-w-4xl">
      <div class="border-b-2 border-gray-800 mb-6">
        <div class="flex">
          <button
              v-for="tab in tabs"
              :key="tab.id"
              @click="SelectionTab(tab.id)"
              :class="[
              'px-6 py-3 font-medium cursor-pointer whitespace-nowrap',
              activeTab === tab.id ? 'bg-gray-800 text-white' : 'bg-white text-gray-800 hover:bg-gray-100'
            ]"
          >
            {{ tab.name }}
          </button>
        </div>
      </div>

      <!-- Â∏ñÂ≠êÂàóË°® -->
      <div class="flex flex-col gap-3">
        <div
            v-for="(post, index) in Posts"
            :key="index"
            class="animation-delay bg-white border-2 border-gray-800 rounded-lg p-2 shadow-md hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer"
            @click="navigateToPost(post.ID)"
            :style="{ animationDelay: `${index * 0.1}s` }"
        >
          <div class="flex items-center mb-2">
            <img
                :src="post.AuthorAvatar"
                :alt="`${post.AuthorName}ÁöÑÂ§¥ÂÉè`"
                class="w-6 h-6 rounded-full object-cover object-top border-2 border-gray-800"
            />
            <div class="ml-2">
              <h3 class="font-bold text-base" :class="GetTextColor(post.AuthorLevel)">{{ post.AuthorName }}</h3>
            </div>
          </div>

          <div class="mt-2 mb-2 flex items-center gap-2">
            <span class="text-2xl font-bold"> {{ post.Title }} </span>
            <span class="border-2 rounded-md px-1 text-sm" :class="post.TypeColor"> {{post.TypeName}} </span>
            <span v-if="post.IsPrivate" class="text-blue-500 border-2 border-blue-500 rounded-md px-1 text-sm">ÁßÅÂØÜ</span>
            <span v-if="post.IsFeatured" class="text-yellow-500 border-2 border-yellow-500 rounded-md px-1 text-sm">Á≤æÂçé</span>
            <span v-if="post.IsAdminLike" class="text-red-500 border-2 border-red-500 rounded-md px-1 text-sm">ÁÆ°ÁêÜÊé®Ëçê</span>
          </div>

          <p class="text-gray-400 mb-4 whitespace-pre-line text-ellipsis line-clamp-1 text-sm">
            {{ post.Content }}
          </p>

          <div class="flex items-center text-gray-500 text-sm">
            <div class="flex items-center mr-6">
              <i class="far fa-heart mr-1"
                 :class="{
                'text-red-500 fas': post.IsLiked,
                'text-gary-500 far': !post.IsLiked
              }"
              ></i>
              <span>{{ post.Likes }}</span>
            </div>
            <div class="flex items-center">
              <i class="far fa-comment mr-1"></i>
              <span>{{ post.Comments }}</span>
            </div>
            <div class="flex items-center ml-auto">
              <p class="text-sm text-gray-500">{{ post.PublishDate }}</p>
            </div>
          </div>
        </div>
      </div>
      <!-- ÂàÜÈ°µ -->
      <div class="mt-8 mx-auto flex justify-center">
        <el-pagination
            :page-size="postsPerPage"
            :total="totalPages*postsPerPage"
            :pager-count="11"
            layout="prev, pager, next"
            @current-change="handlePageChange"
        />
      </div>
    </div>

    <!-- ‰øÆÊîπ‰ø°ÊÅØÂºπÁ™ó -->
    <div
        v-if="showEditModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click.self="closeEditModal"
    >
      <div
          class="bg-white rounded-lg w-full max-w-md p-6 shadow-xl animate-fade-in"
      >
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold">‰øÆÊîπ‰∏™‰∫∫‰ø°ÊÅØ</h2>
          <button
              @click="closeEditModal"
              class="text-gray-500 hover:text-gray-700 cursor-pointer"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form>
          <div class="mb-6 flex flex-col items-center">
            <div
                class="w-48 h-48 rounded-full overflow-hidden border-2 border-gray-800 mb-2 relative group"
            >
              <img
                  :src="editForm.avatarUrl"
                  alt="Áî®Êà∑Â§¥ÂÉè"
                  class="w-full h-full object-cover object-top"
              />
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Â§¥ÂÉè
                <span class="text-gray-500 text-sm">
                  (‰ΩøÁî®Á¨¨‰∏âÊñπÂõæÂ∫ä‰∏ä‰º†Ôºå‰æãÂ¶Ç:
                  <a href="https://imgurl.org" class="text-blue-400">
                    https://imgurl.org
                  </a>
                  )
                </span>
              </label>
              <input
                  v-model="editForm.avatarUrl"
                  type="text"
                  class="w-2/3 px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:border-gray-800"
                  maxlength="255"
              />
              <button
                  type="button"
                  @click="triggerFileUpload"
                  class="float-right w-3/7 px-3 py-3 bg-gray-800 text-white text-sm rounded-md focus:outline-none"
              >
                ‰∏ä‰º†Êú¨Âú∞ÂõæÁâá
              </button>
              <input
                  type="file"
                  ref="fileInput"
                  class="hidden"
                  accept="image/*"
                  @change="handleFileUpload"
              >
            </div>
          </div>

          <div class="mt-8 flex justify-end space-x-4">
            <button
                type="button"
                @click="closeEditModal"
                class="px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 cursor-pointer whitespace-nowrap !rounded-button"
            >
              ÂèñÊ∂à
            </button>
            <button
                type="button"
                class="px-4 py-2 text-white rounded-md  cursor-pointer whitespace-nowrap !rounded-button"
                :disabled = "DisabledSaveButton"
                :class = "{'bg-gray-300':DisabledSaveButton, 'bg-gray-800 hover:bg-gray-700':!DisabledSaveButton}"
                @click = "saveUserInfo"
            >
              ‰øùÂ≠ò
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import {ref, computed, onMounted, watch} from "vue";
import Header from "@/components/Header.vue";
import {get_user_info, get_user_profile, set_profile, set_role, Award} from "@/api/user";
import {useRoute} from "vue-router";
import {CheckLevel, GetTextColor, GetBgColor, GetRoleName, NextLevelLimit} from "@/utils/level";
import {useUserStore} from "@/store/user";

// ‰ΩøÁî®‰ø°ÊÅØÊ°Ü
import { useMessage } from '@/store/message'
import router from "@/router";
import {upload_image} from "@/api/file";
import {refreshToken} from "@/api/auth";
import {get_like_post, get_page_post, search_post} from "@/api/post";
import {TimestampFormat} from "@/utils/week";
import {PostTypeToColor, PostTypeToName} from "@/utils/post";
const { addMessage } = useMessage()

// Áî®Êà∑‰ø°ÊÅØÁºìÂ≠ò--------------------------------------------------------
let UserMap = new Map();

interface UserInfo {
  username: string;
  avatar: string;
  role : number;
  xp : number;
  level : number;
}

const getUserInfo = async (id : string) : Promise<UserInfo> => {
  let data = UserMap.get(id)
  if (!data) {
    // ‰∏çÂ≠òÂú®ÔºåÂºÇÊ≠•ËØ∑Ê±ÇÁî®Êà∑‰ø°ÊÅØ
    const resp = await get_user_info({id:id})
    data = resp.data.data
    data.level = CheckLevel(data.xp,data.role);
    UserMap.set(id, data)
    console.log("ÁºìÂ≠òÁî®Êà∑‰ø°ÊÅØ",data)
  }
  return data
}
//-------------------------------------------------------------------

const UserStore = useUserStore()

// Áî®Êà∑‰ø°ÊÅØ
const userInfo = ref({
  userid:"",
  username: "",
  avatarUrl:
      "",
  realName: "",
  grade: 24,
  studentId: "",
  codeforcesId: "",
  codeforcesRating: 0,
  experience: 0,
  maxExperience: 0,
  experiencePercentage: 20,
  role : 0,
  level: 0,
  nextLevelXp : 0,
  signature: "",
  awards: [] as Award[]
});

const route = useRoute()

onMounted( async () => {
  LoadUserInfo();
})

const LoadUserInfo = async () => {
  addMessage('Âä†ËΩΩ‰∏≠...', 'info')
  const data = await get_user_profile({id: String(route.params.id)})
  console.log(data)
  // Â§¥ÂÉè
  if (data.data.data.avatar.length > 0) {
    userInfo.value.avatarUrl = data.data.data.avatar;
  } else {
    console.log("Áî®Êà∑Â§¥ÂÉè‰∏∫Á©∫");
    userInfo.value.avatarUrl = "/assets/default_avatar.png";
  }
  // Áî®Êà∑ID
  userInfo.value.userid = String(route.params.id);
  // Áî®Êà∑Âêç
  userInfo.value.username = data.data.data.username;
  // ÂßìÂêç
  console.log("ÂßìÂêç"+data.data.data.real_name)
  userInfo.value.realName = format(data.data.data.real_name);
  // Âπ¥Á∫ß
  userInfo.value.grade = data.data.data.grade;
  // Â≠¶Âè∑
  userInfo.value.studentId = format(data.data.data.student_no);
  // Codeforces ID
  userInfo.value.codeforcesId = format(data.data.data.codeforces_id);
  // Codeforces Rating
  userInfo.value.codeforcesRating = data.data.data.codeforces_rating;
  // ÁªèÈ™å
  userInfo.value.experience = data.data.data.xp;
  // ÊùÉÈôêËßíËâ≤
  userInfo.value.role = data.data.data.role;
  // ‰∏™ÊÄßÁ≠æÂêç
  userInfo.value.signature = data.data.data.signature;
  // Ëé∑Â•ñÁªèÂéÜÔºàËá™Âä®ÊéíÂ∫èÔºö‰∏ÄÁ≠âÂ•ñ > ‰∫åÁ≠âÂ•ñ > ‰∏âÁ≠âÂ•ñÔºâ
  userInfo.value.awards = (data.data.data.awards || []).sort((a: Award, b: Award) => a.level - b.level);

  console.log("Áî®Êà∑ÊùÉÈôêÁ≠âÁ∫ß:",data.data.data.role)
  // Á≠âÁ∫ß
  userInfo.value.level = CheckLevel(data.data.data.xp,data.data.data.role);
  console.log("Á≠âÁ∫ß",userInfo.value.level);

  // Ê∏≤ÊüìÁªèÈ™åÊù°
  userInfo.value.nextLevelXp = NextLevelLimit(data.data.data.xp,data.data.data.role)
  userInfo.value.maxExperience = userInfo.value.nextLevelXp;
  if (userInfo.value.nextLevelXp==0) {
    userInfo.value.experiencePercentage = 100;
  } else {
    userInfo.value.experiencePercentage = userInfo.value.experience * 100 / userInfo.value.nextLevelXp;
    if (userInfo.value.experiencePercentage > 100) {
      userInfo.value.experiencePercentage = 100;
    }
  }

  console.log("ÊàëÁöÑÊùÉÈôê",UserStore.getUserInfo().role)

  addMessage('Âä†ËΩΩÊàêÂäü', 'success')
}

const editMode = ref(false)

// Âà§Êñ≠ÊòØÂê¶ÂèØ‰ª•ÁºñËæë
const isCanEdit = computed(() => {
  if (UserStore.isLogin()) {
    if (UserStore.getUserInfo().user_id === userInfo.value.userid) {
      return true;
    } else if (UserStore.getUserInfo().role >= 3) {
      // ÁÆ°ÁêÜÂëòÂèØ‰øÆÊîπÊâÄÊúâÁî®Êà∑‰ø°ÊÅØ
      return true;
    }
  }
  return false;
});

// Âà§Êñ≠ÊòØÂê¶ÊòØË∂ÖÁ∫ßÁÆ°ÁêÜÂëò
const isSuperAdmin = computed(() => {
  if (UserStore.isLogin()) {
    if (UserStore.getUserInfo().role >= 4) {
      return true;
    }
  }
  return false;
})

const isAdmin = computed(() => {
  if (UserStore.isLogin()) {
    if (UserStore.getUserInfo().role >= 3) {
      return true;
    }
  }
  return false;
})

const format = (s:string) => {
  if (s.length > 0) return s;
  else return "Êó†";
}

// Ê†áÁ≠æÈ°µ
const tabs = [
  { id: "diary", name: "ÊâìÂç°Âë®ËÆ∞" },
  { id: "post", name: "Â∏ñÂ≠ê" },
];
const activeTab = ref("diary");

const SelectionTab = (id : string) => {
    activeTab.value = id;
    currentPage.value = 1;
    LoadPosts();
}


// ÂàÜÈ°µÁõ∏ÂÖ≥
const currentPage = ref(1);
const postsPerPage = ref(3);
const totalPages = ref(1);

const IsLoading = ref(false);
const Posts = ref<any[]>([]);

const PostMAP = new Map<string,boolean>();

onMounted(async () => {
  await LoadPosts();
})


// Âä†ËΩΩÂ∏ñÂ≠êÂàóË°®
const LoadTime = ref(0);
const LoadPosts = async () => {
  Posts.value = [];
  LoadTime.value = new Date().getTime();
  const NowLoadTime = LoadTime.value;

  let data;
  data = await get_page_post({
    type: activeTab.value,
    source: "",
    page : currentPage.value,
    by : "user",
    user_id : String(route.params.id),
    count : postsPerPage.value,
  })
  console.log(data)
  if (data.data.data.length > 0) {
    // Âæ™ÁéØÂä†ÂÖ•Â∏ñÂ≠êÂàóË°®
    for (const post of data.data.data.posts) {
      console.log(post);
      PostMAP.set(post.id, true);
      const Author = await getUserInfo(post.user_id);
      const isLiked = await get_like_post({post_id: post.id});
      if (LoadTime.value != NowLoadTime) {
        // ‰∏çÂÜçÂä†ËΩΩÊ≠§Ê¨°Êï∞ÊçÆÔºåÈÄÄÂá∫Âæ™ÁéØ
        break;
      }
      //console.log(isLiked);
      Posts.value.push({
        ID: post.id,
        AuthorID: post.user_id,
        AuthorName: Author.username,
        AuthorAvatar: Author.avatar,
        AuthorXp: Author.xp,
        AuthorLevel: Author.level,
        PublishTime: post.created_at,
        PublishDate: TimestampFormat(new Date(post.created_at)),

        TypeColor: PostTypeToColor(post.type),
        TypeName: PostTypeToName(post.type),
        Title: post.title,
        Content: post.content_short,
        Likes: post.likes,
        Comments: post.comments,

        IsAdminLike: post.is_admin_like,
        IsFeatured: post.is_featured,
        IsPrivate: post.is_private,

        IsLiked: isLiked.data.data.is_like,
        Source: post.source,
        Weight: post.weight,
      });
    }
  }
  totalPages.value = data.data.data.page_total
  IsLoading.value = false;
}

// Â§ÑÁêÜÂàÜÈ°µ
const handlePageChange = (val: number) => {
  currentPage.value = val;
  Posts.value = []; // Ê∏ÖÁ©∫Â∏ñÂ≠êÂàóË°®
  LoadPosts(); // ÈáçÊñ∞Âä†ËΩΩÂ∏ñÂ≠êÂàóË°®
  console.log("ÂΩìÂâçÈ°µÁ†Å:", currentPage.value);
};

const navigateTo = (url : string) => {
  router.push(url);
};

// Ë∑≥ËΩ¨Âà∞Â∏ñÂ≠êËØ¶ÊÉÖÈ°µÈù¢
const navigateToPost = (id : string) => {
  router.push('/learn/'+id);
};


// ÁºñËæëË°®Âçï
const showEditModal = ref(false);
const editForm = ref({
  username: "",
  avatarUrl: "",
  realName: "",
  grade: 0,
  studentId: "",
  codeforcesId: "",
  role: 0,
  signature: "",
  awards: [] as Award[]
});

const openEditMode = () => {
  editForm.value = { 
    ...userInfo.value,
    awards: JSON.parse(JSON.stringify(userInfo.value.awards)) // Deep copy awards array
  };
  editMode.value = true;
}

// ÊâìÂºÄÁºñËæëÂºπÁ™ó
const openEditModal = () => {
  editForm.value = { 
    ...userInfo.value,
    awards: JSON.parse(JSON.stringify(userInfo.value.awards)) // Deep copy awards array
  };
  showEditModal.value = true;
};

// ÂÖ≥Èó≠ÁºñËæëÂºπÁ™ó
const closeEditModal = () => {
  showEditModal.value = false;
};

// ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
const saveUserInfo = async () => {
  console.log("‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ");
  // ‰øÆÊîπ role
  if (userInfo.value.role != editForm.value.role) {
    const data2 = await set_role({id: String(route.params.id), role: editForm.value.role});
    console.log("‰øÆÊîπÊùÉÈôêËØ∑Ê±Ç:",data2);
  }
  // ÂØπÂ•ñÈ°πËøõË°åÊéíÂ∫èÂêéÂÜç‰øùÂ≠ò
  const sortedAwards = [...editForm.value.awards].sort((a, b) => a.level - b.level);
  // ‰øÆÊîπÁî®Êà∑‰ø°ÊÅØ
  const data = await set_profile({
    id : String(route.params.id),
    username: editForm.value.username,
    avatar: editForm.value.avatarUrl,
    real_name: editForm.value.realName,
    grade: editForm.value.grade,
    student_no: editForm.value.studentId,
    codeforces_id: editForm.value.codeforcesId,
    signature: editForm.value.signature,
    awards: sortedAwards,
  })
  console.log(data.data);
  if (data.data.code != 20000) {
    addMessage(data.data.message || '‰øùÂ≠òÂ§±Ë¥•', 'error')
    return;
  }
  addMessage('‰øùÂ≠òÊàêÂäü','success')

  console.log("‰øÆÊîπÁî®Êà∑ËØ∑Ê±Ç:",data);
  editMode.value = false;
  // Âà∑Êñ∞token
  await refreshToken()

  // userInfo.value = { ...userInfo.value, ...editForm.value };
  // Âà∑Êñ∞È°µÈù¢
  await LoadUserInfo();
  closeEditModal();
};

const DisabledSaveButton = ref(false);
const DisabledRealname = ref(false);
const DisabledUsername = ref(false);

// ‰∏çËÉΩÂåÖÂê´ Á©∫Ê†º
let reg_realname = new RegExp("^[^\\s]{2,20}$");
let reg_username = new RegExp("^[^\\s]{0,30}$");

// ÁõëÂê¨ÁºñËæëË°®ÂçïÂèòÂåñ
watch(
    () => editForm.value.realName,
    (newName) => {
      if (!reg_realname.test(newName) || newName === "") {
        DisabledRealname.value = true;
        console.log(newName,"‰∏çÁ¨¶Âêà");
        handleDisabled()
      } else {
        DisabledRealname.value = false;
        handleDisabled()
      }
    }
);
watch(
    () => editForm.value.username,
    (newName) => {
      if (!reg_username.test(newName) || newName === "") {
        DisabledUsername.value = true;
        console.log(newName,"‰∏çÁ¨¶Âêà");
        handleDisabled()
      } else {
        DisabledUsername.value = false;
        handleDisabled()
      }
    }
);

const handleDisabled = () => {
  DisabledSaveButton.value = DisabledRealname.value && DisabledUsername.value;
}

// ÈôêÂà∂ËæìÂÖ•Êï∞Â≠óÈïøÂ∫¶
const limitNumberLength = (event: any) => {
  if (event.target.value.length > 2) {
    event.target.value = event.target.value.slice(0, 2);
  }
};

// Ê†πÊçÆratingËé∑ÂèñÈ¢úËâ≤Á±ª
const getRatingColorClass = () => {
  const rating = userInfo.value.codeforcesRating;
  if (rating < 1200) return "text-gray-500"; // Newbie
  if (rating < 1400) return "text-green-600"; // Pupil
  if (rating < 1600) return "text-cyan-600"; // Specialist
  if (rating < 1900) return "text-blue-600"; // Expert
  if (rating < 2100) return "text-purple-600"; // Candidate Master
  if (rating < 2400) return "text-orange-500"; // Master
  if (rating < 2600) return "text-orange-600"; // International Master
  if (rating < 3000) return "text-red-600"; // Grandmaster
  return "text-red-700"; // International Grandmaster
};

// Âú®setupÈÉ®ÂàÜÊ∑ªÂä†Ôºö
const fileInput = ref<HTMLInputElement | null>(null);

// Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
const triggerFileUpload = () => {
  fileInput.value?.click();
};

// Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
const handleFileUpload = async (event: Event) => {
  const target = event.target as HTMLInputElement;
  const file = target.files?.[0];

  if (!file) return;

  // È™åËØÅÊñá‰ª∂Á±ªÂûãÂíåÂ§ßÂ∞èÔºàÈôêÂà∂5MBÔºâ
  if (!file.type.startsWith('image/')) {
    addMessage('Âè™ËÉΩ‰∏ä‰º†ÂõæÁâáÊñá‰ª∂', 'error');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    addMessage('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB', 'error');
    return;
  }

  try {
    addMessage('‰∏ä‰º†‰∏≠...', 'info');
    const formData = new FormData();
    formData.append('file', file);

    const response = await upload_image(formData);

    if (response.data.code === 20000) {
      editForm.value.avatarUrl = response.data.data.url;
      addMessage('‰∏ä‰º†ÊàêÂäü', 'success');
    }
  } catch (error) {
    addMessage('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
    console.error('Upload error:', error);
  } finally {
    // Ê∏ÖÁ©∫inputÂÄº‰ª•ÂÖÅËÆ∏ÈáçÂ§ç‰∏ä‰º†Âêå‰∏ÄÊñá‰ª∂
    if (fileInput.value) fileInput.value.value = '';
  }
};

const roleOptions = [
    { value: 0, label: "ÊôÆÈÄöÁî®Êà∑" },
    { value: 1, label: "ÊôÆÈÄöÊàêÂëò" },
    { value: 2, label: "Ê≠£ÂºèÊàêÂëò" },
    { value: 3, label: "ÁÆ°ÁêÜÂëò" },
    { value: 4, label: "Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò" }
]

// Ëé∑Â•ñÁõ∏ÂÖ≥ÂáΩÊï∞
const addAward = () => {
  editForm.value.awards.push({
    name: "",
    level: 1
  });
};

const removeAward = (index: number) => {
  editForm.value.awards.splice(index, 1);
};

const getAwardIcon = (level: number) => {
  switch(level) {
    case 1: return "ü•á";
    case 2: return "ü•à";
    case 3: return "ü•â";
    default: return "üèÖ";
  }
};

// Êó∂Èó¥Á∫øÊ†∑ÂºèÁõ∏ÂÖ≥ÂáΩÊï∞
const getAwardCircleClass = (level: number) => {
  switch(level) {
    case 1: return "bg-gradient-to-br from-yellow-300 to-yellow-500";
    case 2: return "bg-gradient-to-br from-gray-300 to-gray-400";
    case 3: return "bg-gradient-to-br from-orange-300 to-orange-400";
    default: return "bg-gray-300";
  }
};

const getAwardLineColor = (level: number) => {
  switch(level) {
    case 1: return "bg-yellow-400";
    case 2: return "bg-gray-400";
    case 3: return "bg-orange-400";
    default: return "bg-gray-300";
  }
};

const getAwardTextColor = (level: number) => {
  switch(level) {
    case 1: return "text-yellow-600";
    case 2: return "text-gray-600";
    case 3: return "text-orange-600";
    default: return "text-gray-500";
  }
};

</script>

<style scoped>
.animate-fade-in {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.floating-component {
  position: fixed; /* Âõ∫ÂÆö‰ΩçÁΩÆ */
  bottom: 5%; /* ‰∏ãËæπË∑ù */
  right: 5%; /* Âè≥ËæπË∑ù */
  z-index: 10000; /* ËÆæÁΩÆ z-index Á°Æ‰øùÊÇ¨ÊµÆÂú®È°∂Â±Ç */
}

.animation-delay {
  animation: fadeInUp 0.6s ease-out both;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translate3d(0, 30px, 0);
  }
  to {
    opacity: 1;
    transform: translate3d(0, 0, 0);
  }
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
</style>
